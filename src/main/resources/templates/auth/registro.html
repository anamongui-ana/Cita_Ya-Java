<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Cita Ya - Registro</title>
    <link rel="icon" type="image" th:href="@{/Assets/img/logoti.png}">
    <link rel="stylesheet" th:href="@{/Assets/css/registro.css}">
    
    <style>
        /* Ajustes para dos columnas sin scroll */
        .container_formulario-login {
            max-height: 70vh;
            overflow-y: auto;
            padding-right: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.8rem;
            column-gap: 1.2rem;
        }

        .form-grid .label,
        .form-grid .input {
            margin-bottom: 0;
        }

        .label {
            margin-bottom: 0.3rem;
        }

        .input input,
        .input select {
            padding: 0.6rem;
            font-size: 0.9rem;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .login_button {
            margin-top: 1rem;
            grid-column: 1 / -1;
        }

        h2 {
            font-size: 1.3rem !important;
            margin-bottom: 0.8rem !important;
        }
    </style>
</head>

<body class="body">

    <div class="container_login">

        <div class="apartado_1">
            <div class="container_login-form">

                <div class="logo-name">
                    <img th:src="@{/Assets/img/nom.png}">
                </div>

                <h2 style="text-align: center;">Registro de Paciente</h2>

                <!-- Formulario de registro -->
                <form class="container_formulario-login" method="POST" th:action="@{/registro}" th:object="${paciente}">

                    <!-- Mensaje de error -->
                    <div th:if="${error}" class="full-width"
                        style="background:#ffe6e6; color:#900; padding:8px; border-radius:6px; margin-bottom:10px; font-size: 0.85rem;">
                        <p th:text="${error}"></p>
                    </div>

                    <div class="form-grid">
                        
                        <!-- Tipo de documento -->
                        <div>
                            <div class="label">
                                <label class="text">Tipo de documento</label>
                            </div>
                            <div class="input">
                                <select name="tipoDoc" th:field="*{tipoDoc}" required>
                                    <option value="">Seleccione...</option>
                                    <option value="CC">CC</option>
                                    <option value="TI">TI</option>
                                    <option value="CE">CE</option>
                                    <option value="PP">Pasaporte</option>
                                </select>
                            </div>
                        </div>

                        <!-- Número de documento -->
                        <div>
                            <div class="label">
                                <label class="text">Número de documento</label>
                            </div>
                            <div class="input">
                                <input type="text" name="numeroDoc" th:field="*{numeroDoc}" placeholder="40XXXXXXXX o 10XXXXXXXX"
                                    oninput="validarNumeroDoc(this)" required>
                            </div>
                        </div>

                        <!-- Nombre -->
                        <div>
                            <div class="label">
                                <label class="text">Nombre</label>
                            </div>
                            <div class="input">
                                <input type="text" id="nombre" name="nombre" th:field="*{nombre}" placeholder="Juan Carlos"
                                    oninput="validarNombre(this)" maxlength="50" required>
                            </div>
                        </div>

                        <!-- Apellido -->
                        <div>
                            <div class="label">
                                <label class="text">Apellido</label>
                            </div>
                            <div class="input">
                                <input type="text" id="apellido" name="apellido" th:field="*{apellido}" placeholder="Pérez González"
                                    oninput="validarApellido(this)" maxlength="50" required>
                            </div>
                        </div>

                        <!-- Género -->
                        <div>
                            <div class="label">
                                <label class="text">Género</label>
                            </div>
                            <div class="input">
                                <select name="genero" th:field="*{genero}" required>
                                    <option value="">Seleccione...</option>
                                    <option value="M">Masculino</option>
                                    <option value="F">Femenino</option>
                                    <option value="Otro">Otro</option>
                                </select>
                            </div>
                        </div>

                        <!-- Fecha de nacimiento -->
                        <div>
                            <div class="label">
                                <label class="text">Fecha de nacimiento</label>
                            </div>
                            <div class="input">
                                <input type="date" id="fechaNacimiento" name="fechaNacimiento" th:field="*{fechaNacimiento}" required>
                            </div>
                        </div>

                        <!-- Tipo de sangre -->
                        <div>
                            <div class="label">
                                <label class="text">Tipo de sangre</label>
                            </div>
                            <div class="input">
                                <select name="tipoSangre" th:field="*{tipoSangre}" requiredal>
                                    <option value="">Opcional</option>
                                    <option value="A+">A+</option>
                                    <option value="A-">A-</option>
                                    <option value="B+">B+</option>
                                    <option value="B-">B-</option>
                                    <option value="AB+">AB+</option>
                                    <option value="AB-">AB-</option>
                                    <option value="O+">O+</option>
                                    <option value="O-">O-</option>
                                </select>
                            </div>
                        </div>

                        <!-- Teléfono -->
                        <div>
                            <div class="label">
                                <label class="text">Teléfono</label>
                            </div>
                            <div class="input">
                                <input type="tel" name="telefono" th:field="*{telefono}"
                                    oninput="validarTelefono(this)" placeholder="310XXXXXXX" required>
                            </div>
                        </div>

                        <!-- Correo - ancho completo -->
                        <div class="full-width">
                            <div class="label">
                                <label class="text">Correo electrónico</label>
                            </div>
                            <div class="input">
                                <input type="email" id="correo" name="correo" th:field="*{correo}" 
                                    placeholder="usuario@correo.com" oninput="validarCorreo(this)"
                                    maxlength="100" required>
                            </div>
                        </div>

                        <!-- Dirección - ancho completo -->
                        <div class="full-width">
                            <div class="label">
                                <label class="text">Dirección</label>
                            </div>
                            <div class="input">
                                <input type="text" name="direccion" th:field="*{direccion}" 
                                    placeholder="Calle 123 #45-67" maxlength="100" required>
                            </div>
                        </div>

                        <!-- Contraseña -->
                        <div>
                            <div class="label">
                                <label class="text">Contraseña</label>
                            </div>
                            <div class="input">
                                <input type="password" id="contrasena" name="contrasena" th:field="*{contrasena}" minlength="8"
                                    placeholder="Min. 8 caracteres" pattern="(?=.*[A-Z])(?=.*[!@#$%^&*])\S{8,}"
                                    title="8 caracteres, 1 mayúscula y 1 especial" required>
                            </div>
                        </div>

                        <!-- Confirmar Contraseña -->
                        <div>
                            <div class="label">
                                <label class="text">Confirmar contraseña</label>
                            </div>
                            <div class="input">
                                <input type="password" id="confirmarContrasena" name="confirmarContrasena" minlength="8"
                                    placeholder="Repite tu contraseña" required>
                            </div>
                        </div>

                        <!-- Botón -->
                        <button type="submit" class="login_button full-width">Registrarse</button>

                        <!-- Link a login -->
                        <div class="no-cuenta full-width" style="text-align: center; margin-top: 0.5rem;">
                            <p>¿Ya tienes cuenta? <a th:href="@{/login}">Inicia sesión</a></p>
                        </div>

                    </div>
                </form>

            </div>
        </div>

        <!-- Parte decorativa -->
        <div class="apartado_2">
            <div class="emoji-icon">
                <img th:src="@{/Assets/img/logoti.png}">
            </div>

            <div class="h1-info">
                <h1>¡Únete a nosotros!</h1>
            </div>

            <div class="P-info">
                <p>Crea tu cuenta y comienza a gestionar tu salud</p>
            </div>

            <div class="p-info">
                <p>✓ Registro rápido y seguro</p>
                <p>✓ Acceso a tu historial médico</p>
                <p>✓ Agenda tus citas en minutos</p>
            </div>
        </div>

    </div>

    <script>
        // Restricción de fecha: máximo 1 mes anterior y mínimo 90 años atrás
        window.addEventListener('DOMContentLoaded', function() {
            const fechaInput = document.getElementById('fechaNacimiento');
            
            // Fecha máxima: hace 1 mes
            const maxFecha = new Date();
            maxFecha.setMonth(maxFecha.getMonth() - 1);
            
            // Fecha mínima: hace 90 años
            const minFecha = new Date();
            minFecha.setFullYear(minFecha.getFullYear() - 90);
            
            // Formatear fechas a YYYY-MM-DD
            fechaInput.max = maxFecha.toISOString().split('T')[0];
            fechaInput.min = minFecha.toISOString().split('T')[0];
        });

        // Validar número de documento: debe empezar con 40 o 10, mínimo 5 dígitos
        function validarNumeroDoc(input) {
            let cleanValue = input.value.replace(/\D/g, '').substring(0, 10);
            input.value = cleanValue;
            
            if (cleanValue.length >= 2) {
                const prefijo = cleanValue.substring(0, 2);
                if (prefijo !== '40' && prefijo !== '10') {
                    input.setCustomValidity("El documento debe empezar con 40 o 10");
                    return;
                }
            }
            
            if (cleanValue.length > 0 && cleanValue.length < 5) {
                input.setCustomValidity("El documento debe tener al menos 5 dígitos");
            } else {
                input.setCustomValidity("");
            }
        }

        // Validar nombre: solo letras, mínimo 5 caracteres
        function validarNombre(input) {
            // Primero limpia: solo letras, espacios y tildes
            input.value = input.value.replace(/[^a-zA-ZáéíóúÁÉÍÓÚñÑ\s]/g, '');
            
            // Luego valida longitud (sin contar espacios)
            const sinEspacios = input.value.replace(/\s/g, '');
            if (sinEspacios.length > 0 && sinEspacios.length < 5) {
                input.setCustomValidity("El nombre debe tener al menos 5 caracteres (sin contar espacios)");
            } else {
                input.setCustomValidity("");
            }
        }

        // Validar apellido: solo letras, mínimo 5 caracteres
        function validarApellido(input) {
            // Primero limpia: solo letras, espacios y tildes
            input.value = input.value.replace(/[^a-zA-ZáéíóúÁÉÍÓÚñÑ\s]/g, '');
            
            // Luego valida longitud (sin contar espacios)
            const sinEspacios = input.value.replace(/\s/g, '');
            if (sinEspacios.length > 0 && sinEspacios.length < 5) {
                input.setCustomValidity("El apellido debe tener al menos 5 caracteres (sin contar espacios)");
            } else {
                input.setCustomValidity("");
            }
        }

        // Validar teléfono: debe empezar con 3, exactamente 10 dígitos
        function validarTelefono(input) {
            let cleanValue = input.value.replace(/\D/g, '').substring(0, 10);
            input.value = cleanValue;
            
            if (cleanValue.length >= 1) {
                const prefijo = cleanValue.substring(0, 1);
                if (prefijo !== '3') {
                    input.setCustomValidity("El teléfono debe empezar con 3");
                    return;
                }
            }
            
            if (cleanValue.length > 0 && cleanValue.length < 10) {
                input.setCustomValidity("El teléfono debe tener exactamente 10 dígitos");
            } else {
                input.setCustomValidity("");
            }
        }

        // Validar correo: mínimo 5 caracteres antes del @
        function validarCorreo(input) {
            const valor = input.value;
            const atIndex = valor.indexOf('@');
            
            if (atIndex > 0) {
                const parteLocal = valor.substring(0, atIndex);
                if (parteLocal.length < 5) {
                    input.setCustomValidity("El correo debe tener al menos 5 caracteres antes del @");
                } else {
                    input.setCustomValidity("");
                }
            } else if (atIndex === 0) {
                input.setCustomValidity("El correo debe tener al menos 5 caracteres antes del @");
            } else {
                input.setCustomValidity("");
            }
        }

        // Validar formulario al enviar
        document.querySelector('form').addEventListener('submit', function(e) {
            // Validar contraseñas coincidan
            const password = document.getElementById('contrasena').value;
            const confirmPassword = document.getElementById('confirmarContrasena').value;
            
            if (password !== confirmPassword) {
                e.preventDefault();
                alert('❌ Las contraseñas no coinciden. Por favor verifica.');
                document.getElementById('confirmarContrasena').focus();
                return false;
            }

            // Validar nombre
            const nombre = document.getElementById('nombre').value.replace(/\s/g, '');
            if (nombre.length < 5) {
                e.preventDefault();
                alert('❌ El nombre debe tener al menos 5 caracteres');
                document.getElementById('nombre').focus();
                return false;
            }

            // Validar apellido
            const apellido = document.getElementById('apellido').value.replace(/\s/g, '');
            if (apellido.length < 5) {
                e.preventDefault();
                alert('❌ El apellido debe tener al menos 5 caracteres');
                document.getElementById('apellido').focus();
                return false;
            }

            // Validar correo
            const correo = document.getElementById('correo').value;
            const atIndex = correo.indexOf('@');
            if (atIndex > 0) {
                const parteLocal = correo.substring(0, atIndex);
                if (parteLocal.length < 5) {
                    e.preventDefault();
                    alert('❌ El correo debe tener al menos 5 caracteres antes del @');
                    document.getElementById('correo').focus();
                    return false;
                }
            }
        });
    </script>
    
</body>

</html>