<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Citas Médicas - Panel Administrativo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/Assets/CSS/table.css}">
    <style>
        * { font-family: arial, sans-serif; margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: #f8f9fa; padding-top: 100px; }
        header { position: fixed; top: 0; width: 100%; z-index: 1000; background-color: #fff; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); }
        .container_header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 2rem; }
        .logo { width: 5rem; height: 5rem; position: relative; left: 6rem; }
        .profile_dropdown { position: relative; display: inline-block; }
        .profile_button { background-color: #059669; color: white; padding: 0.7rem 1.5rem; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 0.5rem; transition: all 0.2s; position: relative; right: 6rem; }
        .profile_button:hover { background-color: #10b981; }
        .dropdown_content { display: none; position: absolute; right: 6rem; background-color: white; min-width: 200px; box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2); z-index: 1001; border-radius: 0.5rem; overflow: hidden; }
        .dropdown_content.show { display: block; }
        .dropdown_item { color: #333; padding: 12px 16px; text-decoration: none; display: block; transition: background-color 0.2s; cursor: pointer; background: #fff; border: none; width: 100%; }
        .dropdown_item:hover { background-color: #f1f1f1; }
        .admin-navbar { background-color: #fff; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); padding: 0.8rem 1.5rem; border-bottom: 3px solid #059669; position: sticky; top: 0; z-index: 999; }
        .admin-navbar .navbar-nav { display: flex; flex-direction: row; align-items: center; gap: 0.5rem; justify-content: center; list-style: none; }
        .admin-navbar .nav-link { color: #3b82f6; font-weight: 600; display: flex; align-items: center; gap: 0.4rem; padding: 0.6rem 1rem; border-radius: 0.5rem; transition: all 0.3s ease; white-space: nowrap; text-decoration: none; }
        .admin-navbar .nav-link:hover, .admin-navbar .nav-link.active { background: #f0fdf4; color: #059669; transform: translateY(-2px); }
        .admin-navbar .nav-link i { font-size: 1rem; color: #059669; transition: color 0.3s; }
        .admin-navbar .nav-link:hover i { color: #10b981; }
        .container { max-width: 1400px; margin: 2rem auto; padding: 0 2rem; }
        .alert { padding: 1rem; margin-bottom: 1rem; border-radius: 0.5rem; display: flex; align-items: center; gap: 0.5rem; }
        .alert-success { background-color: #d1fae5; color: #065f46; border: 1px solid #6ee7b7; }
        .alert-danger { background-color: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
        .btn-close { margin-left: auto; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: inherit; }
    </style>
</head>
<body>
    <header>
        <div class="container_header">
            <img class="logo" th:src="@{/Assets/img/logo.png}" alt="Cita Ya Logo">
            <div class="profile_dropdown">
                <button class="profile_button" onclick="toggleDropdown()">
                    <i class="fas fa-user-cog"></i>
                    <span th:if="${session.nombreCompleto}" th:text="'Admin ' + ${session.nombreCompleto}"></span>
                    <span th:unless="${session.nombreCompleto}">Admin Usuario</span>
                </button>
                <div class="dropdown_content" id="profileDropdown">
                    <button class="dropdown_item">Ver Mi Perfil</button>
                    <button class="dropdown_item">Editar Perfil</button>
                    <hr style="margin: 0;">
                    <form method="POST" th:action="@{/logout}" style="margin: 0;">
                        <button type="submit" class="dropdown_item">Cerrar Sesión</button>
                    </form>
                </div>
            </div>
        </div>
    </header>

    <nav class="navbar navbar-expand-lg admin-navbar">
        <div class="container">
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link" th:href="@{/pacientes}"><i class="fas fa-users me-1"></i>Pacientes</a></li>
                    <li class="nav-item"><a class="nav-link" th:href="@{/medicos}"><i class="fas fa-user-md me-1"></i>Médicos</a></li>
                    <li class="nav-item"><a class="nav-link active" th:href="@{/agendamientos}"><i class="fas fa-calendar-alt me-1"></i>Citas</a></li>
                    <li class="nav-item"><a class="nav-link" th:href="@{/historiales}"><i class="fas fa-file-medical me-1"></i>Historiales</a></li>
                    <li class="nav-item"><a class="nav-link" th:href="@{/administradores}"><i class="fas fa-user-shield me-1"></i>Administradores</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="main-content py-4">
        <div class="container">
            <div th:if="${success}" class="alert alert-success alert-dismissible fade show">
                <i class="fas fa-check-circle me-2"></i>
                <span th:text="${success}"></span>
                <button type="button" class="btn-close" onclick="this.parentElement.style.display='none'">&times;</button>
            </div>

            <div th:if="${error}" class="alert alert-danger alert-dismissible fade show">
                <i class="fas fa-exclamation-circle me-2"></i>
                <span th:text="${error}"></span>
                <button type="button" class="btn-close" onclick="this.parentElement.style.display='none'">&times;</button>
            </div>

            <h1>Citas Médicas</h1>

            <div class="mb-3 d-flex gap-2">
                <!-- Botón para Administradores -->
                <a th:if="${tipoUsuario == 'administrador'}" th:href="@{/agendamientos/create}" class="btn-new">
                    <i class="fas fa-plus me-1"></i>Crear Nueva Cita
                </a>
                
                <!-- Botón para Pacientes -->
                <a th:if="${tipoUsuario == 'paciente'}" th:href="@{/agendamientos/nuevo}" class="btn-new">
                    <i class="fas fa-plus me-1"></i>Agendar Cita
                </a>
                
                <!-- Botón de reporte solo para administradores -->
                <a th:href="@{/agendamientos/reporte}" target="_blank" class="btn-report" th:if="${tipoUsuario == 'administrador'}">
                    <i class="fas fa-file-pdf me-1"></i>Generar Reporte PDF
                </a>
                                
            </div>

            <table class="table mt-3">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Tipo de Cita</th>
                        <th>Fecha</th>
                        <th>Hora</th>
                        <th>Paciente</th>
                        <th>Médico</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:if="${agendamientos == null or agendamientos.isEmpty()}">
                        <td colspan="7" class="text-center"><em>No hay citas registradas</em></td>
                    </tr>
                    <tr th:each="a : ${agendamientos}">
                        <td th:text="${a.idAgendamiento}">1</td>
                        <td th:text="${a.cita}">Consulta General</td>
                        <td th:text="${a.fecha != null ? #dates.format(a.fecha, 'dd/MM/yyyy') : 'N/A'}">01/01/2024</td>
                        <td th:text="${a.hora}">10:00</td>
                        <td>
                            <span th:if="${a.paciente != null}" th:text="${a.paciente.nombre + ' ' + a.paciente.apellido}">Paciente</span>
                            <span th:unless="${a.paciente != null}">Sin paciente</span>
                        </td>
                        <td>
                            <span th:if="${a.medico != null}" th:text="${a.medico.nombre + ' ' + a.medico.apellido}">Médico</span>
                            <span th:unless="${a.medico != null}">Sin médico</span>
                        </td>
                        <td>
                            <!-- Botones para Administrador -->
                            <div th:if="${tipoUsuario == 'administrador'}">
                                <a th:href="@{/agendamientos/{id}(id=${a.idAgendamiento})}" class="btn btn-info btn-sm">Ver</a>
                                <a th:href="@{/agendamientos/editar/{id}(id=${a.idAgendamiento})}" class="btn btn-warning btn-sm">Editar</a>
                                <form th:action="@{/agendamientos/eliminar/{id}(id=${a.idAgendamiento})}" method="POST" style="display:inline;">
                                    <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('¿Eliminar esta cita?')">Eliminar</button>
                                </form>
                            </div>
                            
                            <!-- Botones para Paciente -->
                            <div th:if="${tipoUsuario == 'paciente'}">
                                <a th:href="@{/agendamientos/editar/{id}(id=${a.idAgendamiento})}" class="btn btn-warning btn-sm">Editar</a>
                                <form th:action="@{/agendamientos/eliminar/{id}(id=${a.idAgendamiento})}" method="POST" style="display:inline;">
                                    <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('¿Cancelar esta cita?')">Cancelar</button>
                                </form>
                            </div>
                            
                            <!-- Botones para Médico -->
                            <div th:if="${tipoUsuario == 'medico'}">
                                <a th:href="@{/agendamientos/{id}(id=${a.idAgendamiento})}" class="btn btn-info btn-sm">Ver Detalles</a>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>

    <script>
        function toggleDropdown() {
            document.getElementById("profileDropdown").classList.toggle("show");
        }
        window.onclick = function (event) {
            if (!event.target.matches('.profile_button')) {
                var dropdowns = document.getElementsByClassName("dropdown_content");
                for (var i = 0; i < dropdowns.length; i++) {
                    var openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                }
            }
        }
    </script>
</body>
</html>
